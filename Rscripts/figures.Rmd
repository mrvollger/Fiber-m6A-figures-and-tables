---
title: "R Notebook"
output: html_notebook
editor_options: 
  chunk_output_type: console
---

```{r, echo=FALSE}
system("mkdir -p Figures")
```

```{r}
source('Rscripts/utils.R')
sm="PS00075_1"
gmm = read_m6a("data/{sm}.gmm.tbl.gz", my_tag="GMM", ref=F)
cnn = read_m6a("data/{sm}.cnn.tbl.gz", my_tag="CNN", ref=F, min_ml = 200)
xgb = read_m6a("data/{sm}.xgb.tbl.gz", my_tag="XGB", min_ml = 250, ref=F)
semi = read_m6a("data/{sm}.semi.tbl.gz", my_tag="SEMI", min_ml=230, ref=F)
pb = read_m6a("from_pb/{sm}.fiberseq.strip_meth_tags.gamma_v4_cov1.bam.tbl.gz", my_tag="PacBio", min_ml = 250, nrows=8084, ref=F)
```

```{r}
source('Rscripts/utils.R')
sm="PS00109_1"
sm="GM12878"
gmm = read_m6a("data/{sm}.gmm.tbl.gz", my_tag="GMM", ref=F)
cnn = read_m6a("data/{sm}.cnn.tbl.gz", my_tag="CNN", ref=F, min_ml = 215)
xgb = read_m6a("data/{sm}.xgb.tbl.gz", my_tag="XGB", min_ml = 245, ref=F)
semi = read_m6a("data/{sm}.semi.tbl.gz", my_tag="SEMI", min_ml=244, ref=F)
if(sm == "PS00109_1"){
    all_revio=NULL
} else{
    all_revio = read_m6a("data/Revio.semi.tbl.gz", my_tag="Revio", ref=F, min_ml=230)
}
pb = NULL
```

```{r}
revio = all_revio %>% filter(type=="m6A") %>% filter(m6a_qual >= 254); dim(revio)
```

```{r}
dists_df = rbindlist(list(cnn, xgb, gmm, pb, semi, revio)) 
dists_df[
    order(start),
    c("dist", "count_per_fiber"):= list(start - lag(start), .N),
    by=list(tag, type, fiber)
]
dists_df = dists_df[count_per_fiber/fiber_length > 0.02 & type == "m6A"]
dists_df = dists_df[order(tag, type, fiber, start)]

dists_df %>% group_by(tag) %>% summarise(n())
dists_df %>% group_by(tag) %>% summarise(n()/sum(unique(fiber_length))*100)
```


```{r}
source('Rscripts/utils.R')
calls_per_group = dists_df %>% 
    filter(type=="m6A" & dist > 30 & dist < 300) %>%
    group_by(tag) %>% summarise(count=n())
min_count = min(calls_per_group$count)
p = dists_df %>%
    filter(type=="m6A" & dist > 30 & dist < 300) %>%
    group_by(tag) %>%
    mutate(row_id = seq(n())) %>%
    filter(row_id <= min_count) %>%
    ggplot(aes(x=dist)) +
    geom_density(aes(color=tag), adjust=0.5) +
    scale_x_continuous("Distance between adjacent m6A") +
    scale_y_continuous("Density") +
    scale_color_manual("", values=MODEL_COLORS) +
    coord_cartesian(xlim=c(60,250)) +
    theme_cowplot() +
    theme(legend.position="top")
if (T){
z = p + 
    geom_text_repel(
        data = get_maxima_from_plot(p, n_keep=1),
        aes(x=x, y=y, label=round(x)), 
        size = 3,
        #nudge_y=0.001,
        min.segment.length = 0, # draw all line segments
    )
} else {
    z=p+ facet_zoom(x = dist > 60 & dist < 250,  horizontal = FALSE, shrink=TRUE, ylim=c(0,0.015))

}

my_ggsave("Figures/{sm}-distance-between-adjacent-m6A.pdf", height=6, width=8)

```





```{r}
LAG=275
calls_per_group2 = dists_df %>% 
    filter(type=="m6A") %>%
    group_by(tag) %>% summarise(count=n())
min_count2 = min(calls_per_group2$count)
min_count2=20e5

t = dists_df %>%
    filter(type=="m6A") %>%
    group_by(tag) %>%
    mutate(row_num = seq(n())) %>%
    filter(row_num < min_count2) %>%
    group_by(tag, fiber) %>%
    summarise(
        count = n(),
        index = list(seq(0, max(start)) %in% start)
    )  %>%
    filter(count > 400) %>%
    ungroup() %>%
    group_by(tag) %>%
    summarise(
        auto = acf(as.numeric(unlist(index)), lag.max = LAG, plot = F)$acf,
    ) %>%
    group_by(tag) %>%
    mutate(
        lag = seq(n())
    ) %>%
    data.table()
t %>% group_by(tag) %>% summarise(n())
```

```{r}
t$change <- c(0, (t$auto[1:(length(t$auto)-1)] * t$auto[2:length(t$auto)]) <= 0)
t[change==1]

t %>%
    filter(lag > 25) %>%
    ggplot(aes(x=lag, y=auto, color=tag)) +
    geom_hline(aes(yintercept=0), color="darkblue", size=1, linetype="dashed") + 
    geom_line() +
    geom_text_repel( data = . %>% filter(change == 1),
        aes(y=0, x = lag, label=lag),
        min.segment.length = 0, # draw all line segments
        nudge_x=20,
    )+
    scale_color_manual("", values=MODEL_COLORS) +
    theme_minimal_grid() + 
    scale_y_continuous("Autocorrelation between m6A events") + 
    scale_x_continuous("Lag between m6A events") + 
    theme(legend.position = "top")
my_ggsave("Figures/{sm}-autocorrelation-between-m6A.pdf", height=6, width=8)
```


```{r}
n = 2; 147*n + 60*(n-1)
```




# m6A calls by coverage
```{r}
ft_cov = fread("data/PS00075_1.semi.filtered.tbl.gz") 
gmm_cov = fread("data/PS00075_1.gmm.tbl.gz") 
```

```{r}
m6a_by_cov = rbindlist(list(ft=ft_cov, gmm=gmm_cov), idcol=TRUE) %>%
    as_tibble() %>%
    mutate(coverage = round(ec)) %>%
    mutate(coverage = case_when(
        coverage > 15 ~ 15,
        TRUE ~ coverage
    )) %>%
    group_by(.id, coverage) %>%
    summarise(n_fibers = n(), m6A = sum(total_m6a_bp), AT_bp = sum(total_AT_bp)) 

m6a_by_cov_ratio = m6a_by_cov %>% 
    pivot_wider(id_cols = c("n_fibers", "coverage", "AT_bp"), names_from=".id", values_from = "m6A") %>%
    mutate(
        fc = ft/gmm
    )

m6a_by_cov_ratio   %>%
    ggplot(aes(
            x=coverage, y=fc,
            color=ft, fill=ft
        )
    ) +
    geom_point() + geom_line() +
    geom_text_repel(
        aes(label=paste(comma(100*fc), "%"))
        )+
    geom_hline(
        data=NULL,
        aes(yintercept=1),
        linetype="dashed", color="darkred"
    ) +
    geom_xsidehistogram(
        aes(y=AT_bp),
        stat="identity",
        binwidth=1,
        width = .6,
    ) +
    scale_xsidey_continuous(
        name="# of m6A bases",
        label=comma
    ) +
    scale_y_continuous("% increase in m6A calls",
        labels = function(x) paste0(100*x, "%")
    ) + 
    scale_x_continuous("CCS coverage",
        breaks = seq(0,15),
        labels = c(seq(0,14), "15+")
    )+
    theme_minimal_grid() + 
    theme(
        legend.position="none",
        ggside.panel.scale = .15,
    )
my_ggsave("Figures/Increase-in-m6A-calls-by-coverage.pdf", height=6, width=8)
```
